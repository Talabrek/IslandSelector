---
phase: 13-state-preservation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
autonomous: true

must_haves:
  truths:
    - "restoreNovaBlocks returns RestoreResult with machine counts"
    - "RestoreResult.getFeedbackMessage() returns success message for preserved machines"
    - "RestoreResult.getFeedbackMessage() includes failure count when restoration fails"
    - "Only TileEntity blocks (with drops) are counted as machines"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java"
      provides: "RestoreResult inner class and enhanced restoreNovaBlocks"
      contains: "public static class RestoreResult"
  key_links:
    - from: "restoreNovaBlocks method"
      to: "RestoreResult"
      via: "return statement"
      pattern: "return new RestoreResult"
    - from: "RestoreResult.getFeedbackMessage"
      to: "machinesRestored/machinesFailed counts"
      via: "message formatting"
      pattern: "Preserved.*Nova machines"
---

<objective>
Add RestoreResult return type to restoreNovaBlocks and implement feedback message generation for Nova machine preservation.

Purpose: Players need feedback after island operations to know their Nova machines (inventory, owner) were preserved. This completes NOVA-05 through NOVA-08 requirements at the NovaIntegration layer.

Output: NovaIntegration.restoreNovaBlocks returns RestoreResult with machine counts and feedback message generation. Callers (Phase 14) will wire this to player messages.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-state-preservation/13-RESEARCH.md
@src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RestoreResult inner class with feedback message generation</name>
  <files>src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java</files>
  <action>
Add a new public static inner class RestoreResult inside NovaIntegration with:

1. Fields: `public final int machinesRestored` and `public final int machinesFailed`

2. Constructor: `public RestoreResult(int machinesRestored, int machinesFailed)`

3. Method `getFeedbackMessage()` returns String:
   - If machinesFailed > 0: return "Preserved N Nova machines (M couldn't be restored)"
   - Else if machinesRestored > 0: return "Preserved N Nova machines"
   - Else: return null (no Nova machines to report)

4. Helper methods:
   - `hasFailures()` returns machinesFailed > 0
   - `hasSuccesses()` returns machinesRestored > 0

Place the class after NovaBlockData class (end of file, before final closing brace).

Pattern from 13-RESEARCH.md Example 2.
  </action>
  <verify>File compiles: `mvn compile -q` succeeds with no errors</verify>
  <done>RestoreResult class exists with machinesRestored, machinesFailed fields, getFeedbackMessage(), hasFailures(), hasSuccesses() methods</done>
</task>

<task type="auto">
  <name>Task 2: Enhance restoreNovaBlocks to return RestoreResult with machine counts</name>
  <files>src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java</files>
  <action>
Modify the existing restoreNovaBlocks method:

1. Change return type from `void` to `RestoreResult`

2. Add early return at start: If !available or empty blocks, return `new RestoreResult(0, 0)`

3. Add tracking variables after the existing `restored` counter:
   - `int machinesRestored = 0`
   - `int machinesFailed = 0`

4. After the block placement loop (line ~354), add a second loop to verify TileEntity restoration:
   - For each NovaBlockData where `data.drops != null && !data.drops.isEmpty()`:
     - Get TileEntity at the restored location using WorldDataManager.getTileEntity(loc)
     - If tileEntity != null: machinesRestored++
     - Else: machinesFailed++
   - Use try-catch to handle reflection errors (count as failure)

5. Update log statement to include machine counts when > 0:
   - Current: `"Restored " + restored + "/" + novaBlocks.size() + " Nova blocks"`
   - Add: `if (machinesRestored > 0 || machinesFailed > 0) addon.log("Nova machines: " + machinesRestored + " restored, " + machinesFailed + " failed")`

6. Return `new RestoreResult(machinesRestored, machinesFailed)` instead of void return

7. Update restoreNovaBlocksAsync callback type from `Consumer<Boolean>` to `Consumer<RestoreResult>`:
   - Change method signature
   - Pass RestoreResult to callback instead of true
   - Handle early returns with `new RestoreResult(0, 0)`

Key reflection code for getTileEntity (already cached in captureNovaBlocks):
```java
Class<?> worldDataManagerClass = Class.forName("xyz.xenondevs.nova.world.format.WorldDataManager");
Object worldDataManager = worldDataManagerClass.getField("INSTANCE").get(null);
java.lang.reflect.Method getTileEntityMethod = worldDataManagerClass.getMethod("getTileEntity", Location.class);
Object tileEntity = getTileEntityMethod.invoke(worldDataManager, loc);
```

Note: Reflection setup may fail - wrap in try-catch and log warning, return RestoreResult(0, 0) on setup failure.
  </action>
  <verify>
1. `mvn compile -q` succeeds
2. `mvn package -q` produces JAR without errors
  </verify>
  <done>
1. restoreNovaBlocks returns RestoreResult instead of void
2. restoreNovaBlocksAsync passes RestoreResult to callback
3. Machine counting only counts blocks with drops (TileEntity data)
4. Log output includes machine restoration stats
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `mvn clean package -q`
2. NovaIntegration.java contains:
   - `public static class RestoreResult`
   - `public RestoreResult restoreNovaBlocks(`
   - `return new RestoreResult(`
   - `"Preserved.*Nova machines"` pattern in getFeedbackMessage
3. No compilation errors or warnings related to return types
</verification>

<success_criteria>
- RestoreResult inner class exists with machinesRestored, machinesFailed, getFeedbackMessage(), hasFailures(), hasSuccesses()
- restoreNovaBlocks returns RestoreResult (not void)
- restoreNovaBlocksAsync callback receives RestoreResult
- Machine counting only includes blocks with drops (TileEntity data)
- Build passes: `mvn clean package -q` produces JAR
</success_criteria>

<output>
After completion, create `.planning/phases/13-state-preservation/13-01-SUMMARY.md`
</output>
