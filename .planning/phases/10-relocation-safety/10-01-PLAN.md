---
phase: 10-relocation-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/managers/RelocationManager.java
autonomous: true

must_haves:
  truths:
    - "Player standing on island being relocated is teleported to new location"
    - "Player elsewhere in world (spawn, other island, nether) is not teleported"
    - "Team members on island are teleported; team members elsewhere are not"
    - "Visitors on island are handled; visitors elsewhere are not affected"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/managers/RelocationManager.java"
      provides: "Relocation with location-based teleport filtering"
      contains: "island.onIsland"
  key_links:
    - from: "performRelocationAsync"
      to: "island.onIsland(player.getLocation())"
      via: "Check before teleport to spawn"
      pattern: "onIsland.*getLocation"
    - from: "teleportPlayersSafely"
      to: "island.onIsland(member.getLocation())"
      via: "Check each team member before teleport"
      pattern: "onIsland.*getLocation"
---

<objective>
Fix relocation to only teleport players who are actually standing on the island being relocated.

Purpose: Currently, relocation unconditionally teleports the owner and all online team members regardless of their location. A player at spawn or on another island gets unexpectedly teleported. This breaks user expectations and violates RELC-01/RELC-02.

Output: Modified RelocationManager.java that checks `island.onIsland(player.getLocation())` before any teleportation, following the pattern already established in SlotSwitchManager.teleportVisitorsAway().
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-relocation-safety/10-RESEARCH.md

# Reference pattern (already working in codebase)
@src/main/java/world/bentobox/islandselector/managers/SlotSwitchManager.java (lines 806-826, teleportVisitorsAway method)

# File to modify
@src/main/java/world/bentobox/islandselector/managers/RelocationManager.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add location check to player relocation flow</name>
  <files>src/main/java/world/bentobox/islandselector/managers/RelocationManager.java</files>
  <action>
Modify `performRelocationAsync()` (around line 565) to check if player is on the island before teleporting to spawn:

1. Get the island BEFORE checking location (need island reference for onIsland check):
```java
private void performRelocationAsync(Player player, GridCoordinate fromCoord, GridCoordinate toCoord) {
    UUID playerUUID = player.getUniqueId();

    // Get island to check if player is on it
    World bskyblockWorld = addon.getGridManager().getBSkyBlockWorld();
    Island island = bskyblockWorld != null ? addon.getIslands().getIsland(bskyblockWorld, playerUUID) : null;

    // Capture whether player is on their island BEFORE any async operations
    final boolean playerIsOnIsland = island != null && island.onIsland(player.getLocation());

    // Capture player's origin world BEFORE teleporting to spawn
    final World originWorld = player.getWorld();
```

2. Only teleport to spawn if `playerIsOnIsland` is true:
```java
    Bukkit.getScheduler().runTask(addon.getPlugin(), () -> {
        if (playerIsOnIsland) {
            // Player IS on island - teleport to safety
            World spawnWorld = Bukkit.getWorld("world");
            // ... existing spawn logic ...
            sendProgress(player, "&eTeleported to spawn for safety during relocation...");
        } else {
            // Player is NOT on island - skip initial teleport, just notify
            addon.log("Skipping pre-relocation teleport - " + player.getName() + " not on island");
        }
```

3. Pass `playerIsOnIsland` flag to `performRelocationWork()`:
   - Add parameter: `performRelocationWork(player, playerUUID, fromCoord, toCoord, originWorld, playerIsOnIsland)`
   - Update method signature to accept this flag
  </action>
  <verify>Code compiles: `mvn compile -q` passes with no errors</verify>
  <done>performRelocationAsync checks island.onIsland before teleporting player to spawn</done>
</task>

<task type="auto">
  <name>Task 2: Add location check to teleportPlayersSafely for owner and team members</name>
  <files>src/main/java/world/bentobox/islandselector/managers/RelocationManager.java</files>
  <action>
Modify `teleportPlayersSafely()` (around line 1236) to use the passed flag and check team member locations:

1. Update method signature to accept `playerWasOnIsland` flag:
```java
private void teleportPlayersSafely(Island island, Player owner, Location newCenter, World originWorld, boolean playerWasOnIsland) {
```

2. Only teleport owner if they were on the island:
```java
// Only teleport owner if they were on the island when relocation started
if (playerWasOnIsland) {
    new SafeSpotTeleport.Builder(addon.getPlugin())
        .entity(owner)
        .location(homeLocation)
        // ... existing builder chain ...
} else {
    addon.log("Skipping owner teleport - " + owner.getName() + " was not on island");
}
```

3. For team members, check CURRENT location (they may have moved during async operation):
```java
for (UUID memberUUID : island.getMemberSet()) {
    if (!memberUUID.equals(owner.getUniqueId())) {
        Player member = Bukkit.getPlayer(memberUUID);
        if (member != null && member.isOnline()) {
            // Only teleport if member is currently on the island
            if (island.onIsland(member.getLocation())) {
                new SafeSpotTeleport.Builder(addon.getPlugin())
                    .entity(member)
                    .location(finalHomeLocation)
                    .thenRun(() -> member.sendMessage(colorize("&eYour island has been relocated to a new location!")))
                    .buildFuture();
            } else {
                addon.log("Skipping team member teleport - " + member.getName() + " not on island");
            }
        }
    }
}
```

4. Update all call sites of `teleportPlayersSafely` to pass the new flag.
  </action>
  <verify>Code compiles: `mvn compile -q` passes with no errors</verify>
  <done>teleportPlayersSafely only teleports owner (if was on island) and team members (if currently on island)</done>
</task>

<task type="auto">
  <name>Task 3: Add location check to admin relocation flow</name>
  <files>src/main/java/world/bentobox/islandselector/managers/RelocationManager.java</files>
  <action>
Modify `performAdminRelocationAsync()` (around line 279) and `teleportPlayersSafelyForAdmin()` (around line 510):

1. In `performAdminRelocationAsync()`, check if target player is on their island before teleporting to spawn:
```java
private void performAdminRelocationAsync(UUID adminUUID, UUID targetUUID, String targetName,
                                          GridCoordinate fromCoord, GridCoordinate toCoord) {
    // Get island to check if target is on it
    World bskyblockWorld = addon.getGridManager().getBSkyBlockWorld();
    Island island = bskyblockWorld != null ? addon.getIslands().getIsland(bskyblockWorld, targetUUID) : null;

    Player targetPlayer = Bukkit.getPlayer(targetUUID);
    // Capture whether target is on their island
    final boolean targetIsOnIsland = targetPlayer != null && island != null && island.onIsland(targetPlayer.getLocation());

    if (targetPlayer != null && targetPlayer.isOnline() && targetIsOnIsland) {
        // Target IS on island - teleport to safety
        Bukkit.getScheduler().runTask(addon.getPlugin(), () -> {
            // ... existing teleport to spawn logic ...
        });
    } else if (targetPlayer != null && targetPlayer.isOnline()) {
        // Target is online but NOT on island - just notify, don't teleport
        targetPlayer.sendMessage(colorize("&6&l[Admin Notice]"));
        targetPlayer.sendMessage(colorize("&eYour island is being relocated by an administrator."));
    }
```

2. Pass the flag through to `performAdminRelocationWork()` and on to `teleportPlayersSafelyForAdmin()`.

3. In `teleportPlayersSafelyForAdmin()`, only teleport if the flag indicates target was on island:
```java
private void teleportPlayersSafelyForAdmin(Island island, Player targetPlayer, Location newCenter, boolean targetWasOnIsland) {
    // Only teleport if target was on the island
    if (!targetWasOnIsland) {
        addon.log("Skipping admin relocation teleport - target was not on island");
        return;
    }
    // ... existing teleport logic ...
}
```
  </action>
  <verify>Code compiles: `mvn compile -q` passes with no errors. Full build: `mvn clean package -q` succeeds.</verify>
  <done>Admin relocation only teleports target player if they were actually on their island</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   mvn clean package -q
   ```
   JAR builds successfully at target/IslandSelector-1.0.0.jar

2. **Code verification:**
   - Grep for `onIsland.*getLocation` in RelocationManager.java to confirm checks are in place
   - Verify no unconditional teleports remain in relocation flow

3. **Manual testing scenarios (for SUMMARY documentation):**
   - Player on island -> relocates -> teleported to new location (expected)
   - Player at spawn -> relocates -> stays at spawn (expected: RELC-02)
   - Team member on island -> owner relocates -> teleported (expected)
   - Team member at spawn -> owner relocates -> stays at spawn (expected: RELC-02)
   - Admin relocates player on island -> player teleported (expected)
   - Admin relocates player at spawn -> player stays at spawn (expected: RELC-02)
</verification>

<success_criteria>
- [x] `island.onIsland(player.getLocation())` check added to performRelocationAsync
- [x] `island.onIsland(member.getLocation())` check added for team members in teleportPlayersSafely
- [x] Location check added to admin relocation flow
- [x] Build succeeds with `mvn clean package -q`
- [x] RELC-01 satisfied: Players on island are teleported to new location
- [x] RELC-02 satisfied: Players elsewhere are not affected by relocation
</success_criteria>

<output>
After completion, create `.planning/phases/10-relocation-safety/10-01-SUMMARY.md`
</output>
