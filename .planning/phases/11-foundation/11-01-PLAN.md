---
phase: 11-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/Settings.java
  - src/main/java/world/bentobox/islandselector/IslandSelector.java
  - src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
autonomous: true

must_haves:
  truths:
    - "NovaIntegration detects Nova 0.17+ correctly using updated reflection paths"
    - "Player sees 'Nova integration enabled' message when available"
    - "Config option nova.enabled controls whether Nova integration runs"
    - "System gracefully degrades when Nova not installed or disabled"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/Settings.java"
      provides: "novaEnabled config field with getter/setter"
      contains: "@ConfigEntry(path = \"integration.nova.enabled\")"
    - path: "src/main/java/world/bentobox/islandselector/IslandSelector.java"
      provides: "Conditional NovaIntegration initialization"
      contains: "settings.isNovaEnabled()"
    - path: "src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java"
      provides: "Updated Nova 0.17+ reflection paths with graceful fallback"
      contains: "xyz.xenondevs.nova.world.block"
  key_links:
    - from: "IslandSelector.java"
      to: "Settings.java"
      via: "isNovaEnabled() check before creating NovaIntegration"
      pattern: "settings\\.isNovaEnabled\\(\\)"
    - from: "IslandSelector.java"
      to: "NovaIntegration.java"
      via: "conditional instantiation"
      pattern: "if.*novaEnabled.*NovaIntegration"
    - from: "NovaIntegration.java"
      to: "Nova 0.17+ API"
      via: "reflection with Class.forName"
      pattern: "xyz\\.xenondevs\\.nova\\.world\\.block"
---

<objective>
Update NovaIntegration to work with Nova 0.17+ API and add config toggle for admin control.

Purpose: Phase 11 Foundation establishes Nova 0.17+ compatibility and config-based control, which later phases (12-15) depend on for capture/restore operations.

Output:
- Settings.java with `integration.nova.enabled` config option
- IslandSelector.java with conditional NovaIntegration initialization
- NovaIntegration.java with updated reflection paths for Nova 0.17+
</objective>

<execution_context>
@C:\Users\Administrator\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Administrator\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation/11-RESEARCH.md

# Source files to modify
@src/main/java/world/bentobox/islandselector/Settings.java
@src/main/java/world/bentobox/islandselector/IslandSelector.java
@src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nova config toggle and conditional initialization</name>
  <files>
    src/main/java/world/bentobox/islandselector/Settings.java
    src/main/java/world/bentobox/islandselector/IslandSelector.java
  </files>
  <action>
    **Settings.java changes:**

    Add Nova integration toggle after line 172 (after levelAddonEnabled), following the exact pattern of other integration toggles:

    ```java
    @ConfigComment("Enable Nova integration for custom block support")
    @ConfigComment("Preserves Nova machines during relocation, slot switch, and backups")
    @ConfigEntry(path = "integration.nova.enabled")
    private boolean novaEnabled = true;
    ```

    Add getter/setter after line 502 (after isLevelAddonEnabled/setLevelAddonEnabled):

    ```java
    public boolean isNovaEnabled() {
        return novaEnabled;
    }

    public void setNovaEnabled(boolean novaEnabled) {
        this.novaEnabled = novaEnabled;
    }
    ```

    **IslandSelector.java changes:**

    Replace lines 110-111 (unconditional NovaIntegration creation) with conditional initialization pattern:

    ```java
    // Initialize Nova integration for custom block support (if enabled)
    if (settings.isNovaEnabled()) {
        novaIntegration = new NovaIntegration(this);
        if (!novaIntegration.isAvailable()) {
            // Nova not installed or not compatible
            novaIntegration = null;
        }
    } else {
        log("Nova integration disabled via config");
    }
    ```

    Update line 161 log message to distinguish between disabled and unavailable:

    ```java
    if (novaIntegration != null) {
        log("Nova integration: Enabled");
    } else if (settings.isNovaEnabled()) {
        log("Nova integration: Not available (Nova plugin not detected)");
    } else {
        log("Nova integration: Disabled via config");
    }
    ```

    Note: Remove the old `log("Nova Integration: " + ...)` line and replace with the conditional block above.
  </action>
  <verify>
    1. Build succeeds: `mvn clean package -q`
    2. Config generates `integration.nova.enabled` field
    3. Grep confirms patterns: `grep -n "isNovaEnabled" src/main/java/world/bentobox/islandselector/IslandSelector.java`
  </verify>
  <done>
    - Settings.java has novaEnabled field with @ConfigEntry annotation
    - IslandSelector.java checks settings.isNovaEnabled() before creating NovaIntegration
    - Log messages clearly distinguish: enabled vs disabled vs unavailable
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and update Nova 0.17+ reflection paths</name>
  <files>
    src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
  </files>
  <action>
    Review and update NovaIntegration.java to ensure Nova 0.17+ compatibility:

    **1. Update detectNova() method (around line 46-85):**

    The current code already tries 0.17+ paths first then falls back. Verify these paths match research findings:
    - Nova 0.17+: `xyz.xenondevs.nova.world.block.BlockManager` (line 58) - CORRECT
    - Nova 0.17+: `xyz.xenondevs.nova.world.block.state.NovaBlockState` (line 70) - CORRECT
    - Fallback: `xyz.xenondevs.nova.data.world.block.*` paths - CORRECT for pre-0.17

    **2. Update log message on successful detection (line 39):**

    Change from:
    ```java
    addon.log("Nova detected - custom block support enabled");
    ```
    To:
    ```java
    addon.log("Nova integration enabled - custom block support active");
    ```

    This matches the success criteria "Player sees 'Nova integration enabled' message when available".

    **3. Verify WorldDataManager path (line 122):**

    Current: `xyz.xenondevs.nova.world.format.WorldDataManager` - verify this is correct for 0.17+

    Per research: WorldDataManager usage is already correct. No change needed.

    **4. Verify BlockUtils path (line 246):**

    Current: `xyz.xenondevs.nova.util.BlockUtils` - verify this is correct for 0.17+

    Per research: This path should work. If it fails, add fallback but unlikely needed.

    **5. Add defensive logging for API mismatch:**

    In detectNova(), after successful class loading, add debug log:
    ```java
    if (addon.getSettings().isDebugEnabled()) {
        addon.log("Nova API detected - using " +
            (blockManagerClass.getName().contains("world.block") ? "0.17+" : "pre-0.17") + " paths");
    }
    ```
  </action>
  <verify>
    1. Build succeeds: `mvn clean package -q`
    2. Log message updated: `grep -n "Nova integration enabled" src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java`
    3. Nova 0.17+ paths present: `grep -n "xyz.xenondevs.nova.world.block" src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java`
  </verify>
  <done>
    - detectNova() logs "Nova integration enabled - custom block support active" on success
    - Reflection paths confirmed for Nova 0.17+ API structure
    - Debug logging indicates which API version detected
    - Graceful fallback to pre-0.17 paths maintained for compatibility
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification:**
   ```bash
   mvn clean package -q
   ```
   Must complete without errors.

2. **Config field present:**
   ```bash
   grep -n "integration.nova.enabled" src/main/java/world/bentobox/islandselector/Settings.java
   ```
   Should show the @ConfigEntry annotation.

3. **Conditional initialization:**
   ```bash
   grep -n "isNovaEnabled" src/main/java/world/bentobox/islandselector/IslandSelector.java
   ```
   Should show the config check before NovaIntegration creation.

4. **Updated log message:**
   ```bash
   grep -n "Nova integration enabled" src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
   ```
   Should show the updated success message.

5. **Nova 0.17+ paths:**
   ```bash
   grep "xyz.xenondevs.nova.world.block" src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
   ```
   Should show the 0.17+ package paths being used.
</verification>

<success_criteria>
Phase 11 success criteria from roadmap must ALL be TRUE:

1. [x] NovaIntegration detects Nova 0.17+ correctly using updated reflection paths
   - Verified by: `grep "xyz.xenondevs.nova.world.block" NovaIntegration.java` returns matches

2. [x] Player sees "Nova integration enabled" message when available
   - Verified by: Log message on line 39 says "Nova integration enabled"

3. [x] Config option `nova.enabled` controls whether Nova integration runs
   - Verified by: Settings.java has novaEnabled field, IslandSelector.java checks it

4. [x] System gracefully degrades when Nova not installed or disabled
   - Verified by: IslandSelector logs appropriate message and novaIntegration remains null
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation/11-01-SUMMARY.md` following the summary template.
</output>
