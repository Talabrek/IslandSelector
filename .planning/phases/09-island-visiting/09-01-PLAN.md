---
phase: 09-island-visiting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/managers/WarpIntegration.java
  - src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java
  - src/main/java/world/bentobox/islandselector/gui/SharedGridGUIListener.java
  - src/main/java/world/bentobox/islandselector/IslandSelector.java
autonomous: true

must_haves:
  truths:
    - "Right-clicking an island without warp shows 'no warp' message instead of teleporting"
    - "Right-clicking an island with warp teleports the player"
    - "GUI shows warp indicator on islands that have warps"
    - "GUI hides 'Right-click to visit' hint when island has no warp"
    - "When Warps addon not installed, visits work as before (no restrictions)"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/managers/WarpIntegration.java"
      provides: "Warps addon integration via reflection"
      exports: ["WarpIntegration"]
      min_lines: 80
    - path: "src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java"
      provides: "Warp indicator and conditional visit hint in GUI"
      contains: "getWarpIntegration"
    - path: "src/main/java/world/bentobox/islandselector/gui/SharedGridGUIListener.java"
      provides: "Warp check before teleporting"
      contains: "getWarpIntegration"
    - path: "src/main/java/world/bentobox/islandselector/IslandSelector.java"
      provides: "WarpIntegration initialization and getter"
      contains: "warpIntegration"
  key_links:
    - from: "MainGridGUI.createOccupiedItem()"
      to: "WarpIntegration.hasWarp()"
      via: "addon.getWarpIntegration().hasWarp(ownerUUID)"
      pattern: "getWarpIntegration\\(\\)\\.hasWarp"
    - from: "SharedGridGUIListener.handleVisitClick()"
      to: "WarpIntegration.hasWarp()"
      via: "addon.getWarpIntegration().hasWarp(ownerUUID)"
      pattern: "getWarpIntegration\\(\\)\\.hasWarp"
    - from: "IslandSelector.onEnable()"
      to: "WarpIntegration constructor"
      via: "warpIntegration = new WarpIntegration(this)"
      pattern: "warpIntegration\\s*=\\s*new\\s+WarpIntegration"
---

<objective>
Implement conditional island visiting based on warp sign availability.

Purpose: Players should only be able to visit islands that have active warp signs. This prevents unwanted visits to islands whose owners haven't set up a warp, respecting player privacy.

Output: WarpIntegration.java (new), modified MainGridGUI.java, modified SharedGridGUIListener.java, modified IslandSelector.java
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-island-visiting/09-RESEARCH.md

Existing patterns to follow:
@src/main/java/world/bentobox/islandselector/managers/LevelIntegration.java
@src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java
@src/main/java/world/bentobox/islandselector/gui/SharedGridGUIListener.java
@src/main/java/world/bentobox/islandselector/IslandSelector.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WarpIntegration.java</name>
  <files>src/main/java/world/bentobox/islandselector/managers/WarpIntegration.java</files>
  <action>
Create WarpIntegration.java following the LevelIntegration.java pattern exactly:

1. Package: `world.bentobox.islandselector.managers`

2. Fields:
   - `private final IslandSelector addon`
   - `private volatile boolean warpAddonPresent = false`
   - `private volatile boolean warpAddonWorking = true`

3. Constructor:
   - Check if Warps addon is present: `BentoBox.getInstance().getAddonsManager().getAddonByName("Warps").isPresent()`
   - Log "Warps addon detected - warp checking enabled" if present
   - Log "Warps addon not found - warp checking disabled (visits unrestricted)" if not present

4. `isEnabled()` method:
   - Return `warpAddonPresent && warpAddonWorking`

5. `hasWarp(UUID playerUUID)` method using reflection:
   - If not enabled, return `false` (meaning no warp restriction - allows visit)
   - Get Warps addon via `getAddonByName("Warps")`
   - Use `findMethod()` to get `getWarpSignsManager()` method
   - Invoke to get manager object
   - Get BSkyBlock world from `addon.getGridManager().getBSkyBlockWorld()`
   - Use `findMethod()` to get `hasWarp(World, UUID)` method (note: World comes FIRST)
   - Invoke and return result as boolean
   - Catch LinkageError -> set `warpAddonWorking = false`, return false
   - Catch Exception -> return false silently

6. `findMethod()` helper (copy from LevelIntegration):
   - Search declared methods to avoid class loading issues
   - Recursively check parent classes
   - Handle LinkageError gracefully

IMPORTANT: The method signature is `hasWarp(World, UUID)` - World parameter comes first.
  </action>
  <verify>
File compiles: `mvn compile -q` succeeds without errors.
Class structure matches LevelIntegration pattern (has isEnabled, main check method, findMethod helper).
  </verify>
  <done>
WarpIntegration.java exists with hasWarp(UUID) method that uses reflection to check Warps addon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WarpIntegration into IslandSelector</name>
  <files>src/main/java/world/bentobox/islandselector/IslandSelector.java</files>
  <action>
Add WarpIntegration to IslandSelector.java following the pattern used for LevelIntegration:

1. Add field near other integrations (around line 54):
   ```java
   private WarpIntegration warpIntegration;
   ```

2. In `onEnable()`, initialize after other integrations (around line 128, after levelIntegration):
   ```java
   warpIntegration = new WarpIntegration(this);
   ```

3. Add getter method (near getLevelIntegration() around line 484):
   ```java
   /**
    * Get the Warps addon integration manager
    */
   public WarpIntegration getWarpIntegration() {
       return warpIntegration;
   }
   ```

4. Add import at top:
   ```java
   import world.bentobox.islandselector.managers.WarpIntegration;
   ```
  </action>
  <verify>
File compiles: `mvn compile -q` succeeds.
`getWarpIntegration()` method is callable from addon instance.
  </verify>
  <done>
IslandSelector has warpIntegration field, initializes it in onEnable(), and exposes getter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Modify GUI and Visit Handler for Warp Checking</name>
  <files>
    src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java
    src/main/java/world/bentobox/islandselector/gui/SharedGridGUIListener.java
  </files>
  <action>
**MainGridGUI.java - Modify createOccupiedItem() method (around lines 516-520):**

Replace the existing "Right-click to visit" section:
```java
// Action hint
if (!isOwnIsland) {
    lore.add("");
    lore.add(colorize("&e\u25b6 Right-click to visit"));
}
```

With conditional warp-aware logic:
```java
// Action hint (only for other players' islands)
if (!isOwnIsland) {
    lore.add("");

    // Check warp availability
    if (addon.getWarpIntegration().isEnabled()) {
        boolean hasWarp = ownerUUID != null && addon.getWarpIntegration().hasWarp(ownerUUID);
        if (hasWarp) {
            lore.add(colorize("&a\u2713 Has Warp"));
            lore.add(colorize("&e\u25b6 Right-click to visit"));
        }
        // No hint shown when no warp - intentional
    } else {
        // Warps addon not installed - show visit hint (unrestricted mode)
        lore.add(colorize("&e\u25b6 Right-click to visit"));
    }
}
```

**SharedGridGUIListener.java - Modify handleVisitClick() method (around line 156):**

Add warp check AFTER the ban check (around line 184) but BEFORE teleport logic:
```java
// Check for warp before teleporting (if Warps addon is enabled)
var warpIntegration = gui.getAddon().getWarpIntegration();
if (warpIntegration.isEnabled()) {
    if (!warpIntegration.hasWarp(location.getOwnerUUID())) {
        player.sendMessage("\u00A7cThis island doesn't have a warp sign.");
        return;
    }
}
```

Insert this block after line 184 (after the ban check) and before line 186 (the ownerName variable).

The complete flow becomes:
1. Check island exists
2. Check if own island (teleport home)
3. Get island from BentoBox
4. Check if banned
5. NEW: Check if has warp (if Warps enabled)
6. Get target location and teleport
  </action>
  <verify>
Build succeeds: `mvn clean package -q` produces JAR.
Review changes:
- MainGridGUI shows warp indicator only when warp exists
- MainGridGUI hides visit hint when no warp (Warps addon enabled)
- MainGridGUI shows visit hint always when Warps addon not installed
- SharedGridGUIListener checks warp before teleporting
- SharedGridGUIListener shows "no warp sign" message when warp missing
  </verify>
  <done>
GUI shows conditional warp indicator/hint, and visit handler checks warp before teleporting.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `mvn clean package -q`
2. Code review:
   - WarpIntegration.java exists and follows LevelIntegration pattern
   - IslandSelector initializes and exposes WarpIntegration
   - MainGridGUI.createOccupiedItem() conditionally shows warp indicator and visit hint
   - SharedGridGUIListener.handleVisitClick() checks warp before teleporting
3. Pattern grep:
   - `grep -r "getWarpIntegration" src/` shows usage in MainGridGUI and SharedGridGUIListener
   - `grep -r "hasWarp" src/` shows WarpIntegration.hasWarp() method
</verification>

<success_criteria>
- WarpIntegration.java created with reflection-based Warps addon integration
- IslandSelector.getWarpIntegration() returns valid WarpIntegration instance
- MainGridGUI shows green checkmark + "Has Warp" only for islands with warps
- MainGridGUI shows "Right-click to visit" only for islands with warps (when Warps addon enabled)
- MainGridGUI shows "Right-click to visit" for all islands (when Warps addon not installed)
- Right-clicking island without warp shows "This island doesn't have a warp sign." message
- Right-clicking island with warp teleports normally
- Build produces working JAR: target/IslandSelector-1.0.0.jar
</success_criteria>

<output>
After completion, create `.planning/phases/09-island-visiting/09-01-SUMMARY.md`
</output>
