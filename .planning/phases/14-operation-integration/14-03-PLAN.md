---
phase: 14-operation-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/managers/BackupManager.java
autonomous: true

must_haves:
  truths:
    - "Backup creation includes Nova machines (captured and stored)"
    - "Backup restoration restores Nova machines (inventory, owner, energy)"
    - "Multi-dimension backups process Nova blocks in all enabled dimensions"
    - "Nova integration gracefully skips when disabled or unavailable"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/managers/BackupManager.java"
      provides: "Nova block capture/restore in backup workflow"
      contains: "captureNovaBlocks"
  key_links:
    - from: "BackupManager.java"
      to: "NovaIntegration.captureNovaBlocks"
      via: "method call during backup creation"
      pattern: "addon\\.getNovaIntegration\\(\\)\\.captureNovaBlocks"
    - from: "BackupManager.java"
      to: "NovaIntegration.restoreNovaBlocks"
      via: "method call during backup restoration"
      pattern: "addon\\.getNovaIntegration\\(\\)\\.restoreNovaBlocks"
---

<objective>
Integrate Nova block preservation into BackupManager workflow

Purpose: Enable backup creation to include Nova machines so that when a backup is restored, all Nova machines (electric furnaces, solar panels, etc.) are restored with their inventory, energy levels, and ownership intact.

Output: BackupManager that saves Nova blocks alongside schematic backups and restores them when a backup is loaded.
</objective>

<execution_context>
@C:\Users\Administrator\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Administrator\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-operation-integration/14-RESEARCH.md
@.planning/phases/12-core-capture-and-restore/12-01-SUMMARY.md
@.planning/phases/13-state-preservation/13-01-SUMMARY.md
@src/main/java/world/bentobox/islandselector/managers/BackupManager.java
@src/main/java/world/bentobox/islandselector/integrations/NovaIntegration.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nova helper methods to BackupManager</name>
  <files>src/main/java/world/bentobox/islandselector/managers/BackupManager.java</files>
  <action>
Add imports for NovaIntegration classes at top of file:
```java
import world.bentobox.islandselector.integrations.NovaIntegration.NovaBlockData;
import world.bentobox.islandselector.integrations.NovaIntegration.RestoreResult;
```

Add helper method for Nova integration availability:

```java
/**
 * Check if Nova integration is available and enabled
 */
private boolean isNovaEnabled() {
    return addon.getNovaIntegration() != null
        && addon.getNovaIntegration().isAvailable()
        && addon.getSettings().isNovaEnabled();
}
```

Add method to get Nova backup file path (stored alongside schematic):

```java
/**
 * Get the Nova blocks backup file for a specific backup schematic.
 * File is stored alongside the schematic with .nova extension.
 *
 * @param schematicFile The schematic backup file
 * @return The Nova blocks file (.nova)
 */
private File getNovaBackupFile(File schematicFile) {
    String schematicPath = schematicFile.getAbsolutePath();
    String novaPath = schematicPath.replace(".schem", ".nova");
    return new File(novaPath);
}
```

Add method to capture and save Nova blocks during backup:

```java
/**
 * Capture Nova blocks for a backup operation.
 *
 * @param playerUUID Player's UUID
 * @param world The world containing the island
 * @param schematicFile The schematic file (used to derive Nova file path)
 * @return true if successful (or Nova not enabled)
 */
private boolean captureAndSaveNovaBlocksForBackup(UUID playerUUID, World world, File schematicFile) {
    if (!isNovaEnabled()) {
        return true;
    }

    Island island = addon.getIslands().getIsland(world, playerUUID);
    if (island == null) {
        return true; // No island, nothing to capture
    }

    Location center = island.getCenter();
    if (center == null || center.getWorld() == null) {
        return true;
    }

    int islandSpacing = addon.getIslandSpacing();
    int protectionRange = island.getProtectionRange();
    int range = Math.max(islandSpacing / 2, protectionRange);

    // Capture Nova blocks
    List<NovaBlockData> novaBlocks = addon.getNovaIntegration().captureNovaBlocks(center, range);

    if (novaBlocks == null || novaBlocks.isEmpty()) {
        return true; // No Nova blocks to save
    }

    // Save to .nova file alongside schematic
    File novaFile = getNovaBackupFile(schematicFile);
    try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(novaFile))) {
        oos.writeObject(novaBlocks);
        addon.log("Saved " + novaBlocks.size() + " Nova blocks to backup: " + novaFile.getName());
        return true;
    } catch (IOException e) {
        addon.logError("Failed to save Nova blocks for backup: " + e.getMessage());
        return false;
    }
}
```

Add method to load and restore Nova blocks during backup restoration:

```java
/**
 * Load and restore Nova blocks from a backup.
 *
 * @param playerUUID Player's UUID
 * @param world The world containing the island
 * @param schematicFile The schematic file (used to derive Nova file path)
 * @return RestoreResult with machine counts
 */
@SuppressWarnings("unchecked")
private RestoreResult loadAndRestoreNovaBlocksFromBackup(UUID playerUUID, World world, File schematicFile) {
    if (!isNovaEnabled()) {
        return new RestoreResult(0, 0);
    }

    File novaFile = getNovaBackupFile(schematicFile);
    if (!novaFile.exists()) {
        return new RestoreResult(0, 0); // No Nova blocks in this backup
    }

    Island island = addon.getIslands().getIsland(world, playerUUID);
    if (island == null || island.getCenter() == null) {
        return new RestoreResult(0, 0);
    }

    // Load Nova blocks from file
    List<NovaBlockData> novaBlocks;
    try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(novaFile))) {
        Object obj = ois.readObject();
        if (obj instanceof List) {
            novaBlocks = (List<NovaBlockData>) obj;
        } else {
            addon.logWarning("Nova backup file has unexpected format");
            return new RestoreResult(0, 0);
        }
    } catch (IOException | ClassNotFoundException e) {
        addon.logError("Failed to load Nova blocks from backup: " + e.getMessage());
        return new RestoreResult(0, 0);
    }

    if (novaBlocks.isEmpty()) {
        return new RestoreResult(0, 0);
    }

    // Restore Nova blocks
    RestoreResult result = addon.getNovaIntegration().restoreNovaBlocks(novaBlocks, island.getCenter());
    addon.log("Restored Nova blocks from backup: " + result.machinesRestored + " machines restored");

    return result;
}
```
  </action>
  <verify>
Search for "isNovaEnabled", "captureAndSaveNovaBlocksForBackup", and "loadAndRestoreNovaBlocksFromBackup" in BackupManager.java.
Run `mvn clean package -q` to verify compilation.
  </verify>
  <done>
BackupManager has Nova helper methods for checking availability, capturing/saving during backup, and loading/restoring during restore operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Nova capture into backup creation</name>
  <files>src/main/java/world/bentobox/islandselector/managers/BackupManager.java</files>
  <action>
Find the `saveSlotToBackup` method and add Nova capture after the schematic is saved successfully.

In `saveSlotToBackup(SlotData slotData, UUID playerUUID, int slotNumber)`:

Find the line:
```java
if (success) {
    addon.log("Backup created for player " + playerUUID + " slot " + slotNumber + ": " + backupFile.getName());
}
```

Replace with (or add after success check):
```java
if (success) {
    addon.log("Backup created for player " + playerUUID + " slot " + slotNumber + ": " + backupFile.getName());

    // Also capture Nova blocks if available
    if (isNovaEnabled()) {
        captureAndSaveNovaBlocksForBackup(playerUUID, world, backupFile);
    }
} else {
    return false;
}
```

Also integrate into `saveSlotToAutoBackup` method with the same pattern:

Find in `saveSlotToAutoBackup`:
```java
if (success) {
    addon.log("Auto-backup created for player " + playerUUID + " slot " + slotNumber);
}
```

Replace with:
```java
if (success) {
    addon.log("Auto-backup created for player " + playerUUID + " slot " + slotNumber);

    // Also capture Nova blocks if available
    if (isNovaEnabled()) {
        World world = center.getWorld();
        if (world != null) {
            captureAndSaveNovaBlocksForBackup(playerUUID, world, backupFile);
        }
    }
}
```

For multi-dimension backups in `saveSlotToBackupForDimension`:

Find:
```java
if (success) {
    addon.log("Backup created for player " + playerUUID + " slot " + slotNumber +
            " dimension " + dimensionKey + ": " + backupFile.getName());
}
```

Replace with:
```java
if (success) {
    addon.log("Backup created for player " + playerUUID + " slot " + slotNumber +
            " dimension " + dimensionKey + ": " + backupFile.getName());

    // Also capture Nova blocks for this dimension
    if (isNovaEnabled()) {
        captureAndSaveNovaBlocksForBackup(playerUUID, world, backupFile);
    }
}
```

Do the same for `saveSlotToAutoBackupForDimension`.
  </action>
  <verify>
1. Search for "captureAndSaveNovaBlocksForBackup" calls in BackupManager.java
2. Verify call appears in saveSlotToBackup, saveSlotToAutoBackup, saveSlotToBackupForDimension, saveSlotToAutoBackupForDimension
3. Run `mvn clean package -q` to verify compilation
  </verify>
  <done>
Backup creation methods (saveSlotToBackup, saveSlotToAutoBackup, and multi-dimension variants) capture and save Nova blocks alongside schematic files.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Nova restore into backup restoration</name>
  <files>src/main/java/world/bentobox/islandselector/managers/BackupManager.java</files>
  <action>
Find the `loadBackupToWorld` method and add Nova restoration after schematic is pasted.

In `loadBackupToWorld(File backupFile, UUID playerUUID, SlotData slotData)`:

Find:
```java
if (success) {
    addon.log("Restored backup " + backupFile.getName() + " for slot: " + slotData.getUniqueId());
}
return success;
```

Replace with:
```java
if (success) {
    addon.log("Restored backup " + backupFile.getName() + " for slot: " + slotData.getUniqueId());

    // Also restore Nova blocks if available
    if (isNovaEnabled()) {
        RestoreResult novaResult = loadAndRestoreNovaBlocksFromBackup(playerUUID, bskyblockWorld, backupFile);
        String novaMessage = novaResult.getFeedbackMessage();
        if (novaMessage != null) {
            addon.log("Backup restore: " + novaMessage);
        }
    }
}
return success;
```

For multi-dimension restore in `loadBackupToWorldForDimension`:

Find:
```java
if (success) {
    addon.log("Restored backup " + backupFile.getName() + " to dimension " + dimensionKey);
}
return success;
```

Replace with:
```java
if (success) {
    addon.log("Restored backup " + backupFile.getName() + " to dimension " + dimensionKey);

    // Also restore Nova blocks for this dimension
    if (isNovaEnabled()) {
        RestoreResult novaResult = loadAndRestoreNovaBlocksFromBackup(playerUUID, world, backupFile);
        String novaMessage = novaResult.getFeedbackMessage();
        if (novaMessage != null) {
            addon.log("Backup restore (" + dimensionKey + "): " + novaMessage);
        }
    }
}
return success;
```
  </action>
  <verify>
1. Search for "loadAndRestoreNovaBlocksFromBackup" calls in BackupManager.java
2. Verify call appears in loadBackupToWorld and loadBackupToWorldForDimension
3. Run `mvn clean package -q` to verify compilation
  </verify>
  <done>
Backup restoration methods (loadBackupToWorld, loadBackupToWorldForDimension) restore Nova blocks from .nova files alongside schematic restoration with logging feedback.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `mvn clean package -q` completes without errors
2. BackupManager imports NovaBlockData and RestoreResult
3. BackupManager has isNovaEnabled() method
4. BackupManager has captureAndSaveNovaBlocksForBackup() method
5. BackupManager has loadAndRestoreNovaBlocksFromBackup() method
6. Backup creation methods call captureAndSaveNovaBlocksForBackup after success
7. Backup restore methods call loadAndRestoreNovaBlocksFromBackup after success
8. Nova blocks are saved to .nova files alongside .schem files
</verification>

<success_criteria>
- Build compiles without errors
- Backup creation captures Nova blocks and saves to .nova file
- Backup restoration loads Nova blocks from .nova file and restores them
- Multi-dimension backups handle Nova blocks per dimension
- Nova integration gracefully skips when disabled or unavailable
- Log messages indicate Nova block counts during backup/restore
- .nova files are created alongside .schem backup files
</success_criteria>

<output>
After completion, create `.planning/phases/14-operation-integration/14-03-SUMMARY.md`
</output>
