---
phase: 08-level-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java
autonomous: true

must_haves:
  truths:
    - "User sees same level number in GUI as `/island level` command shows"
    - "Level updates reflect immediately without reopening GUI"
  artifacts:
    - path: "src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java"
      provides: "Island level display in occupied item lore"
      contains: "getFormattedIslandLevel"
  key_links:
    - from: "MainGridGUI.java"
      to: "LevelIntegration.getFormattedIslandLevel()"
      via: "method call in createOccupiedItem"
      pattern: "getFormattedIslandLevel\\(ownerUUID\\)"
---

<objective>
Fix island level display to match `/island level` command output exactly.

Purpose: The GUI currently uses `getFormattedAggregatedLevel()` which sums levels from ALL dimensions (overworld + nether + end), but the Level addon's `/island level` command only shows the overworld level. This causes user confusion when numbers don't match.

Output: MainGridGUI displays the same level that `/island level` shows, with no stale cached values.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files:
@src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java
@src/main/java/world/bentobox/islandselector/managers/LevelIntegration.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix level display method call</name>
  <files>src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java</files>
  <action>
In the `createOccupiedItem()` method (around line 498-503), change the level display code from:

```java
// Island level from Level addon (aggregated across all dimensions)
if (ownerUUID != null && addon.getLevelIntegration().isEnabled()) {
    String levelStr = addon.getLevelIntegration().getFormattedAggregatedLevel(ownerUUID);
```

To:

```java
// Island level from Level addon (matches /island level command)
if (ownerUUID != null && addon.getLevelIntegration().isEnabled()) {
    String levelStr = addon.getLevelIntegration().getFormattedIslandLevel(ownerUUID);
```

This changes from `getFormattedAggregatedLevel()` to `getFormattedIslandLevel()`.

Why this fixes both requirements:
1. LEVL-01 (accuracy): `getFormattedIslandLevel()` calls `getIslandLevel()` which uses only the BSkyBlock overworld, exactly like the Level addon's `/island level` command does.
2. LEVL-02 (freshness): `getFormattedIslandLevel()` does NOT use the 60-second cache - it makes a fresh API call each time, so levels update immediately when the GUI refreshes.
  </action>
  <verify>
1. Build succeeds: `mvn clean package -q`
2. Code inspection: grep for "getFormattedIslandLevel" in MainGridGUI.java shows the new call
3. Code inspection: grep for "getFormattedAggregatedLevel" in MainGridGUI.java returns no results
  </verify>
  <done>
MainGridGUI uses getFormattedIslandLevel() instead of getFormattedAggregatedLevel(), matching the Level addon's /island level command output with fresh (non-cached) values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and verify</name>
  <files>target/IslandSelector-1.0.0.jar</files>
  <action>
Run Maven build to compile and package the addon:

```bash
mvn clean package -q
```

Verify the build succeeds and the JAR is created. The change is a single method call substitution so no compile errors are expected.
  </action>
  <verify>
1. Build exits with code 0
2. JAR file exists: `target/IslandSelector-1.0.0.jar`
  </verify>
  <done>
Addon builds successfully with the level display fix applied.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Code verification:**
   - `grep -n "getFormattedIslandLevel" src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java` returns the fixed line
   - `grep -n "getFormattedAggregatedLevel" src/main/java/world/bentobox/islandselector/gui/MainGridGUI.java` returns nothing

2. **Build verification:**
   - `ls -la target/IslandSelector-1.0.0.jar` shows the JAR exists

3. **Manual testing (on test server):**
   - Run `/island level` and note the number (e.g., "1,234")
   - Open `/islandselector` GUI and find your island
   - Verify the "Island Level: 1.2K" in lore matches the /island level output
   - Place/remove blocks to change level, run `/island level` again
   - Refresh GUI (close and reopen) - level should update immediately
</verification>

<success_criteria>
- [ ] MainGridGUI.java calls getFormattedIslandLevel() not getFormattedAggregatedLevel()
- [ ] Maven build succeeds
- [ ] JAR file is created in target/
</success_criteria>

<output>
After completion, create `.planning/phases/08-level-display/08-01-SUMMARY.md`
</output>
